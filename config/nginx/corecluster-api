server {
    listen 8000;
    server_name 0.0.0.0;


    # WebVNC Redirections
    location ~* ^/webvnc/([a-zA-Z0-9]+)/$ {
        set $vm_id $1;

        set_by_lua $webvnc_endpoint
              'local f = io.popen("sudo cc-manage vm webvnc " .. ngx.arg[1], "r")
               local s = tostring(f:read("*a"))
               return s .. "/websockify/"' $vm_id;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass $webvnc_endpoint;
    }

    # WebProxy Redirections
    location ~* ^/proxy/([a-zA-Z0-9]+)/$ {
        set $lease_id $1;

        set_by_lua $webproxy_endpoint
              'local f = assert(io.popen("sudo cc-manage vm proxy " .. ngx.arg[1], "r"))
               local s = assert(f:read("*a"))
               return s ' $lease_id;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass $webproxy_endpoint;
    }

    # Administrators panel
    location /admin {
        # allow 127.0.0.1;
        # deny all;
        include         uwsgi_params;
        uwsgi_pass      unix:/var/run/uwsgi/app/corecluster-api/socket;
    }

    # Static Django files
    location /static {
        alias /var/lib/cloudOver/static;
    }

    # Main API
    location / {
        include         uwsgi_params;
        uwsgi_pass      unix:/var/run/uwsgi/app/corecluster-api/socket;
    }
}
