<domain type='vbox'>
  <name>vm-{{ vm.user.id }}-{{ vm.id }}</name>
  <uuid>{{ uuid }}</uuid>
  <memory>{{ vm.template.memory }}</memory>
  <vcpu>{{ vm.template.cpu }}</vcpu>
  <cpu>
    <topology sockets='2' cores='6' threads='2'/>
  </cpu>
  <os>
    <type arch="x86_64" machine="pc">hvm</type>
    <boot dev='cdrom'/>
    <boot dev='hd'/>
  </os>
  <features>
       <acpi/>
       <apic/>
       <pae/>
  </features>
  <clock offset='utc'/>
  <on_poweroff>destroy</on_poweroff>
  <on_reboot>restart</on_reboot>
  <on_crash>restart</on_crash>
  <devices>
      {% for lease in vm.lease_set.all %}
	  <interface type='network'>
          <source network='net-{{ vm.id }}-{{lease.id}}'/>
          <mac address="{{ lease.mac }}"/>
          <model type='{{ vm.base_image.network_device_name }}'/>
	  </interface>
      {% endfor %}

      {% if vm.base_image != None %}
      <disk type='file' device='disk'>
          <driver name='qemu' type='qcow2' cache="writeback" io="threads" />
          <source file='/images/{{ vm.id }}'/>
          <target dev='vda' bus='{{ vm.base_image.disk_controller_name }}'/>
      </disk>
      <!--
      This is better way to attach disk images to VM until libvirt will permit
      this. Ath current (Ubuntu 13.10) version there is permission problem with
      Libvirt to attach disk in this way.
      <disk type='volume' device='disk'>
          <driver name='qemu' type='qcow2'/>
          <source pool='images' volume='{{ vm.id }}'/>
          <target dev='vda' bus='{{ vm.base_image.disk_controller_name }}'/>
      </disk>-->
      {% endif %}

	  {% for img in vm.image_set %}
      <disk type='volume' device='disk'>
          <driver name='qemu' type='qcow2'/>
          <source pool='{{ img.storage.name }}' volume='{{ img.user.id }}_{{ img.id }}'/>
          <target dev='vda' bus='{{ img.disk_controller_name }}' />
      </disk>
	  {% endfor %}

	  <disk type='file' device='cdrom'>
	    <driver name="qemu" type="raw" cache="writeback" io="threads" />
        <target dev='sdz' bus='sata' tray='closed'/>
        <readonly/>
      </disk>

	  <console type='pty' tty='/dev/pts/6'>
	    <source path='/dev/pts/6'/>
	    <target port='0'/>
	  </console>
	  <graphics type='vnc' port='{{ vm.vnc_port }}' listen="0.0.0.0" passwd="{{ vm.vnc_passwd }}" />
	  <video>
	    <model type='{{ vm.base_image.video_device_name }}' vram='9216' heads='1'/>
	  </video>
	  <input type='tablet' bus='usb'/>
  </devices>
</domain>